<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Manager</title>
    <style>
        /* Estilos CSS */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2a6f2a;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        h2 {
            margin-top: 20px;
            color: #555;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .config-item, .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dotted #ccc;
        }
        .player-list {
            max-height: 250px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .player-item:last-child {
            border-bottom: none;
        }
        .player-chips {
            font-weight: bold;
            color: #007bff;
            min-width: 60px;
            text-align: right;
        }
        .result-player {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.1em;
        }
        .gain {
            color: #28a745;
            font-weight: bold;
        }
        .loss {
            color: #dc3545;
            font-weight: bold;
        }
        .no-change {
            color: #6c757d;
        }
        .caja-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        .time-display {
            font-size: 0.9em;
            color: #888;
            text-align: center;
            margin-bottom: 10px;
        }
        .ranking-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.9em;
        }
        .ranking-header {
            font-weight: bold;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>‚ô†Ô∏è Poker Manager ‚ô£Ô∏è</h1>
    <div id="timeDisplay" class="time-display"></div>

    <div id="configSection">
        <h2>üí∞ Configuraci√≥n Inicial</h2>
        <div class="config-item">
            <span>Valor actual de la Caja:</span>
            <span id="cajaValueDisplay" class="caja-display">$10000</span>
        </div>
        <div class="config-item">
            <label for="cajaValue">Nuevo Valor (Entero):</label>
            <input type="number" id="cajaValue" placeholder="Escribe un n√∫mero entero">
            <button class="btn btn-primary" onclick="window.updateCajaValue()">Actualizar Valor</button>
        </div>

        <h2>üë• Selecciona Jugadores</h2>
        <div id="playerSelection" class="player-list">
            </div>

        <div style="text-align: center; margin-top: 10px;">
            <button class="btn btn-secondary" onclick="window.addGuestPlayer()">‚ûï Agregar Invitado</button>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-success" onclick="window.iniciarPartida()">üéÆ Iniciar Partida</button>
        </div>
    </div>

    <div id="gameSection" style="display:none;">
        <h2>üíµ Partida en Curso</h2>
        <div class="config-item">
            <span>Valor de la Caja:</span>
            <span id="cajaGameValueDisplay" class="caja-display"></span>
            <button class="btn btn-secondary" onclick="window.cambiarValorCaja()">Cambiar</button>
        </div>
        
        <h2>Activos:</h2>
        <div id="activePlayersList" class="player-list">
            </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-danger" onclick="window.finalizarJuego()">üèÅ Finalizar Juego</button>
        </div>
    </div>

    <div id="resultsSection" style="display:none;">
        <h2>üìä Resultados de la Partida</h2>
        <div id="resultsList">
            </div>
        <div id="sumCheck" style="margin-top: 15px; font-weight: bold;"></div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-warning" onclick="window.resetearJuego()">üîÑ Nueva Partida</button>
        </div>
    </div>
    
    <div id="rankingSection">
        <h2>üèÜ Ranking Acumulado de Ganancias</h2>
        <div id="rankingGanancias"></div>
        
        <h2>üìâ Ranking Acumulado de P√©rdidas</h2>
        <div id="rankingPerdidas"></div>
    </div>
    </div>

<script>
    // Variables globales
    let cajaValue = 10000;
    let nextPlayerId = 7;
    let allPlayers = [
        { id: 1, name: 'Leo', active: false, cajas: 0, initialFichas: 0, finalFichas: 0, isGuest: false, acumulado: 0 },
        { id: 2, name: 'Diego', active: false, cajas: 0, initialFichas: 0, finalFichas: 0, isGuest: false, acumulado: 0 },
        { id: 3, name: 'Juan', active: false, cajas: 0, initialFichas: 0, finalFichas: 0, isGuest: false, acumulado: 0 },
        { id: 4, name: 'Tano', active: false, cajas: 0, initialFichas: 0, finalFichas: 0, isGuest: false, acumulado: 0 },
        { id: 5, name: 'Miguel', active: false, cajas: 0, initialFichas: 0, finalFichas: 0, isGuest: false, acumulado: 0 },
        { id: 6, name: 'Ale', active: false, cajas: 0, initialFichas: 0, finalFichas: 0, isGuest: false, acumulado: 0 },
    ];
    let intervalId; 
    
    // Nueva variable para el historial de partidas
    let gameHistory = []; 

    // --- MANEJO DE ALMACENAMIENTO (LOCALSTORAGE) ---

    window.saveState = function() {
        // Guarda el historial y los datos acumulados
        localStorage.setItem('pokerManager_history', JSON.stringify(gameHistory));
        localStorage.setItem('pokerManager_players', JSON.stringify(allPlayers.filter(p => !p.isGuest)));
    }

    window.loadState = function() {
        // Carga el historial
        const storedHistory = localStorage.getItem('pokerManager_history');
        if (storedHistory) {
            gameHistory = JSON.parse(storedHistory);
        }

        // Carga los jugadores base (no invitados)
        const storedPlayers = localStorage.getItem('pokerManager_players');
        if (storedPlayers) {
            const loadedPlayers = JSON.parse(storedPlayers);
            
            // Mantenemos solo los jugadores base y actualizamos sus acumulados
            allPlayers.forEach(player => {
                const loadedPlayer = loadedPlayers.find(lp => lp.name === player.name);
                if (loadedPlayer) {
                    player.acumulado = loadedPlayer.acumulado;
                }
            });
        }
    }
    
    // --- FUNCIONES DE ALARMAS Y TIEMPO ---
    // (Funciones checkAlarms, startAlarms, y la actualizaci√≥n de timeDisplay, quedan igual)
    
    window.checkAlarms = function() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const timeDisplay = document.getElementById('timeDisplay');
        
        const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        timeDisplay.textContent = `Hora actual: ${formattedTime}`;

        if (hours === 22 && minutes === 0) {
            alert('üö® ¬°ALARMA! üö®\n\nHORA DE PRENDER EL HORNO Y PREPARAR LA COMIDA.\n\n(Alarma 22:00)');
        }

        if (hours === 23 && minutes === 55) {
            alert('üõë ¬°ATENCI√ìN! üõë\n\nHORA DE LA √öLTIMA MANO.\n\n(Alarma 23:55)');
        }
    }

    window.startAlarms = function() {
        intervalId = setInterval(window.checkAlarms, 60000); 
        window.checkAlarms();
    }
    
    // --- FUNCIONES DE UTILIDAD Y CONFIGURACI√ìN ---

    window.updateCajaValue = function() {
        const input = document.getElementById('cajaValue');
        const newValue = parseFloat(input.value);
        
        if (newValue <= 0 || isNaN(newValue) || newValue % 1 !== 0) { 
            alert('‚ö†Ô∏è Por favor ingrese un valor de caja entero v√°lido mayor a 0');
            input.value = cajaValue;
            return;
        }

        cajaValue = newValue;
        document.getElementById('cajaValueDisplay').textContent = `$${cajaValue}`;
        input.value = '';
    }

    window.togglePlayer = function(id) {
        const player = allPlayers.find(p => p.id === id);
        if (player) {
            player.active = !player.active;
        }
        window.renderPlayerSelection();
    }
    
    window.addGuestPlayer = function() {
        const guestName = prompt("Ingrese el nombre del jugador invitado:");
        if (guestName && guestName.trim() !== '') {
            const newPlayer = {
                id: nextPlayerId++,
                name: guestName.trim() + ' (Inv.)',
                active: true,
                cajas: 0,
                initialFichas: 0,
                finalFichas: 0,
                isGuest: true,
                acumulado: 0 // Los invitados no tienen acumulado persistente
            };
            allPlayers.push(newPlayer);
            window.renderPlayerSelection();
        }
    }

    window.renderPlayerSelection = function() {
        const container = document.getElementById('playerSelection');
        container.innerHTML = '';
        allPlayers.forEach(player => {
            const div = document.createElement('div');
            div.className = 'config-item';
            
            // A√±adir el acumulado en la configuraci√≥n
            const acumuladoText = player.isGuest ? '' : ` ($${player.acumulado})`;
            
            div.innerHTML = `
                <span>${player.name}${acumuladoText}</span>
                <input type="checkbox" ${player.active ? 'checked' : ''} onchange="window.togglePlayer(${player.id})">
            `;
            container.appendChild(div);
        });
    }

    // --- FUNCIONES DE JUEGO ---

    window.iniciarPartida = function() {
        const activePlayers = allPlayers.filter(p => p.active);
        
        if (activePlayers.length < 2) {
            alert('‚ö†Ô∏è Debes seleccionar al menos 2 jugadores para iniciar la partida');
            return;
        }

        window.startAlarms();

        document.getElementById('configSection').style.display = 'none';
        document.getElementById('gameSection').style.display = 'block';

        document.getElementById('cajaGameValueDisplay').textContent = `$${cajaValue}`;

        allPlayers.forEach(player => {
            if (player.active) {
                player.cajas = 0;
                player.initialFichas = 0;
                player.finalFichas = 0;
            }
        });

        window.renderActivePlayers();
    }
    
    // (Funciones renderActivePlayers, pedirCaja, actualizarFichas, cambiarValorCaja quedan iguales)
    window.renderActivePlayers = function() {
        const container = document.getElementById('activePlayersList');
        container.innerHTML = '';

        allPlayers.filter(p => p.active).forEach(player => {
            const div = document.createElement('div');
            div.className = 'player-item';
            div.innerHTML = `
                <span>${player.name} (${player.cajas} Caja(s))</span>
                <div style="display:flex; gap: 10px; align-items:center;">
                    <span id="fichas-${player.id}" class="player-chips">${player.finalFichas || player.initialFichas}</span>
                    <button class="btn btn-primary" onclick="window.pedirCaja(${player.id})">+ Caja</button>
                    <button class="btn btn-secondary" onclick="window.actualizarFichas(${player.id})">Fichas Finales</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    window.pedirCaja = function(id) {
        const player = allPlayers.find(p => p.id === id);
        if (player) {
            player.cajas += 1;
            window.renderActivePlayers();
        }
    }

    window.actualizarFichas = function(id) {
        const player = allPlayers.find(p => p.id === id);
        if (player) {
            let fichas = prompt(`Ingrese la cantidad de Fichas FINALES de ${player.name}:`);
            fichas = parseInt(fichas);

            if (isNaN(fichas) || fichas < 0) {
                alert('‚ö†Ô∏è Por favor ingrese un n√∫mero v√°lido mayor o igual a 0.');
                return;
            }
            player.finalFichas = fichas;
            window.renderActivePlayers();
        }
    }

    window.cambiarValorCaja = function() {
        let nuevoValor = prompt(`Ingrese el nuevo valor de la caja (actual: $${cajaValue}):`);
        nuevoValor = parseInt(nuevoValor);

        if (isNaN(nuevoValor) || nuevoValor <= 0 || nuevoValor % 1 !== 0) {
            alert('‚ö†Ô∏è Por favor ingrese un valor de caja entero v√°lido mayor a 0.');
            return;
        }

        cajaValue = nuevoValor;
        document.getElementById('cajaGameValueDisplay').textContent = `$${cajaValue}`;
        alert(`‚úÖ Valor de la caja actualizado a $${cajaValue}`);
    }

    // --- FUNCIONES DE RESULTADOS Y RANKING ---

    window.finalizarJuego = function() {
        const activePlayers = allPlayers.filter(p => p.active);

        const missingFichas = activePlayers.some(p => p.finalFichas === 0 && p.initialFichas === 0 && p.cajas > 0);
        if (missingFichas) {
            alert('‚ö†Ô∏è Debe ingresar la cantidad de fichas finales de TODOS los jugadores activos.');
            return;
        }

        clearInterval(intervalId);

        document.getElementById('gameSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';

        const results = activePlayers.map(player => {
            const netCajas = player.finalFichas - player.cajas;
            const netMoney = netCajas * cajaValue;

            return {
                name: player.name,
                netCajas: netCajas,
                netMoney: netMoney,
                isGuest: player.isGuest // Nuevo
            };
        });
        
        // **NUEVO: ACTUALIZACI√ìN DEL HISTORIAL Y ACUMULADO**
        const gameDate = new Date().toLocaleDateString('es-AR');
        const gameEntry = {
            date: gameDate,
            results: []
        };
        
        results.forEach(result => {
            // Actualizar el acumulado solo para jugadores NO invitados
            if (!result.isGuest) {
                const player = allPlayers.find(p => p.name.replace(' (Inv.)', '') === result.name.replace(' (Inv.)', ''));
                if (player) {
                    player.acumulado = (player.acumulado || 0) + result.netMoney;
                }
            }
            
            gameEntry.results.push({
                name: result.name,
                netMoney: result.netMoney
            });
        });

        gameHistory.push(gameEntry);
        window.saveState(); // Guardar el estado actualizado

        window.renderResults(results);
        window.renderRanking(); // Renderizar el nuevo ranking
    }

    window.renderResults = function(results) {
        const container = document.getElementById('resultsList');
        container.innerHTML = '';
        let sumTotal = 0;

        results.forEach(result => {
            const div = document.createElement('div');
            div.className = 'result-player';
            
            let statusClass, message;
            
            if (result.netMoney > 0) {
                statusClass = 'gain';
                message = `Gana: +$${Math.abs(result.netMoney)}`;
            } else if (result.netMoney < 0) {
                statusClass = 'loss';
                message = `Pierde: -$${Math.abs(result.netMoney)}`;
            } else {
                statusClass = 'no-change';
                message = 'A mano: $0';
            }

            div.innerHTML = `
                <span>${result.name}</span>
                <span class="${statusClass}">${message}</span>
            `;
            container.appendChild(div);
            sumTotal += result.netMoney;
        });

        const sumCheckDiv = document.getElementById('sumCheck');
        if (Math.abs(sumTotal) < 0.01) {
            sumCheckDiv.className = 'gain';
            sumCheckDiv.textContent = `‚úÖ La suma es $0.00. El c√°lculo es correcto.`;
        } else {
            sumCheckDiv.className = 'loss';
            sumCheckDiv.textContent = `‚ùå ERROR: La suma NO es cero. Faltan $${sumTotal.toFixed(2)}`;
        }
    }
    
    // **NUEVO: FUNCI√ìN PARA RENDERIZAR EL RANKING**
    window.renderRanking = function() {
        const rankingGananciasContainer = document.getElementById('rankingGanancias');
        const rankingPerdidasContainer = document.getElementById('rankingPerdidas');
        
        rankingGananciasContainer.innerHTML = '';
        rankingPerdidasContainer.innerHTML = '';

        // 1. Generar la lista de resultados para el ranking
        const allResults = [];
        
        gameHistory.forEach(game => {
            game.results.forEach(result => {
                if (!result.name.includes('(Inv.)')) { // Excluir invitados
                     // Obtener el acumulado actual del jugador base
                    const player = allPlayers.find(p => p.name === result.name);
                    const acumulado = player ? player.acumulado : 0;
                    
                    allResults.push({
                        date: game.date,
                        name: result.name,
                        partida: result.netMoney,
                        acumulado: acumulado
                    });
                }
            });
        });

        // 2. Filtrar y ordenar ganancias
        const ganancias = allResults
            .filter(r => r.partida > 0)
            .sort((a, b) => b.partida - a.partida);
            
        // 3. Filtrar y ordenar p√©rdidas
        const perdidas = allResults
            .filter(r => r.partida < 0)
            .sort((a, b) => a.partida - b.partida); // Ordenar de menor (m√°s p√©rdida) a mayor

        // 4. Renderizar Ganancias
        const headerGanancias = `<div class="ranking-header ranking-item"><span>Fecha</span><span>Jugador/Ganancia</span><span>Acumulado</span></div>`;
        rankingGananciasContainer.innerHTML += headerGanancias;
        
        if (ganancias.length > 0) {
            ganancias.forEach(r => {
                rankingGananciasContainer.innerHTML += `
                    <div class="ranking-item">
                        <span>${r.date}</span>
                        <span class="gain">${r.name}: +$${Math.abs(r.partida).toFixed(2)}</span>
                        <span>$${r.acumulado.toFixed(2)}</span>
                    </div>`;
            });
        } else {
            rankingGananciasContainer.innerHTML += `<p>No hay ganancias registradas a√∫n.</p>`;
        }

        // 5. Renderizar P√©rdidas
        const headerPerdidas = `<div class="ranking-header ranking-item"><span>Fecha</span><span>Jugador/P√©rdida</span><span>Acumulado</span></div>`;
        rankingPerdidasContainer.innerHTML += headerPerdidas;

        if (perdidas.length > 0) {
            perdidas.forEach(r => {
                rankingPerdidasContainer.innerHTML += `
                    <div class="ranking-item">
                        <span>${r.date}</span>
                        <span class="loss">${r.name}: -$${Math.abs(r.partida).toFixed(2)}</span>
                        <span>$${r.acumulado.toFixed(2)}</span>
                    </div>`;
            });
        } else {
            rankingPerdidasContainer.innerHTML += `<p>No hay p√©rdidas registradas a√∫n.</p>`;
        }
    }


    window.resetearJuego = function() {
        if (!confirm('¬øEst√°s seguro de que quieres empezar una nueva partida? Se perder√°n los datos actuales.')) {
            return;
        }

        clearInterval(intervalId);

        // Resetear visualizaci√≥n
        document.getElementById('configSection').style.display = 'block';
        document.getElementById('gameSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
        
        // Quitar invitados y resetear status de la partida
        allPlayers = allPlayers.filter(p => !p.isGuest);
        allPlayers.forEach(player => {
            player.active = false;
            player.cajas = 0;
            player.initialFichas = 0;
            player.finalFichas = 0;
        });
        nextPlayerId = allPlayers.length + 1;

        // Reinicializar la vista
        window.init();
    }

    // --- INICIALIZACI√ìN ---

    window.init = function() {
        window.loadState(); // Cargar estado al inicio
        document.getElementById('cajaValueDisplay').textContent = `$${cajaValue}`;
        window.renderPlayerSelection();
        window.renderRanking(); // Renderizar ranking al inicio
    }

    // Inicializar al cargar la p√°gina
    window.onload = function() {
        window.init();
    };
</script>

</body>
</html>
